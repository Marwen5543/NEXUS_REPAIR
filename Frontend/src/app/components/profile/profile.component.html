<div class="profile-container">

  <div class="profile-wrapper">
    <br><br><br>
    <!-- Header -->
    <div class="profile-header">
      <div class="header-content">
        <button class="back-btn" (click)="router.navigate(['/dashboard'])">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back
        </button>
        <h1 class="page-title">Profile Settings</h1>
        <p class="page-subtitle">Manage your account settings and preferences</p>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading profile...</p>
    </div>

    <!-- Profile Content -->
    <div *ngIf="!loading && profile" class="profile-content">
      <!-- Profile Card -->
      <div class="profile-card">
  <div class="profile-avatar-section">
    <div class="avatar-large">
      {{ profile.fullName?.charAt(0)?.toUpperCase() || profile.email.charAt(0).toUpperCase() }}
    </div>

    <div class="profile-info">
      <h2 class="profile-name">{{ profile.fullName || 'User' }}</h2>
      <p class="profile-email">{{ profile.email }}</p>

      <!-- New: Contact & Location Info -->
      <div class="profile-details">
        <div *ngIf="profile.phone" class="detail-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
          <span>{{ profile.phone }}</span>
        </div>

        <div *ngIf="profile.whatsappNumber && profile.whatsappNumber !== profile.phone" class="detail-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
          </svg>
          <span>WhatsApp: {{ profile.whatsappNumber }}</span>
        </div>

        <div *ngIf="profile.governorate || profile.city" class="detail-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          <span>
            {{ [profile.governorate, profile.city].filter(Boolean).join(', ') || 'No location set' }}
          </span>
        </div>

        <div *ngIf="profile.addressLine" class="detail-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          <span>{{ profile.addressLine }}</span>
          <span *ngIf="profile.postalCode"> • {{ profile.postalCode }}</span>
        </div>
      </div>

      <div class="profile-meta">
        <span class="meta-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Joined {{ getJoinedDate() }}
        </span>
        <span class="meta-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          {{ profile.roles[0] }}
        </span>
      </div>
    </div>
  </div>
</div>

      <!-- Tabs -->
      <div class="tabs-container">
        <div class="tabs">
          <button
            class="tab"
            [class.active]="activeTab === 'profile'"
            (click)="setActiveTab('profile')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Profile
          </button>
          <button
            class="tab"
            [class.active]="activeTab === 'security'"
            (click)="setActiveTab('security')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Security
          </button>
          <button
            class="tab danger-tab"
            [class.active]="activeTab === 'danger'"
            (click)="setActiveTab('danger')">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Danger Zone
          </button>
        </div>
      </div>

      <!-- Messages -->
      <div *ngIf="successMessage" class="alert alert-success">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        {{ successMessage }}
      </div>

      <div *ngIf="errorMessage" class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        {{ errorMessage }}
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Profile Tab -->
        <div *ngIf="activeTab === 'profile'" class="tab-pane">
          <div class="settings-card">
            <div class="card-header">
              <h3 class="card-title">Personal Information</h3>
              <p class="card-description">Update your personal details</p>
            </div>

            <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="form">

              <!-- Email (disabled) -->
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input
                  type="email"
                  id="email"
                  class="form-input"
                  [value]="profile.email"
                  disabled>
                <p class="form-hint">Email cannot be changed</p>
              </div>

              <!-- Full Name -->
              <div class="form-group">
                <label for="fullName" class="form-label">Full Name</label>
                <input
                  type="text"
                  id="fullName"
                  class="form-input"
                  formControlName="fullName"
                  placeholder="Enter your full name">
                <div *ngIf="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched" class="form-error">
                  <span *ngIf="profileForm.get('fullName')?.errors?.['required']">Full name is required</span>
                  <span *ngIf="profileForm.get('fullName')?.errors?.['minlength']">Full name must be at least 2 characters</span>
                </div>
              </div>

              <!-- Phone Number -->
              <div class="form-group">
                <label for="phone" class="form-label">Phone Number</label>
                <input
                  type="tel"
                  id="phone"
                  class="form-input"
                  formControlName="phone"
                  placeholder="e.g. 22123456 or +21622123456">
                <p class="form-hint">Preferred format: +216 followed by 8 digits</p>
                <div *ngIf="profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched" class="form-error">
                  <span *ngIf="profileForm.get('phone')?.errors?.['pattern']">Invalid Tunisian phone number format</span>
                </div>
              </div>

              <!-- WhatsApp Number -->
              <div class="form-group">
                <label for="whatsappNumber" class="form-label">WhatsApp Number</label>
                <input
                  type="tel"
                  id="whatsappNumber"
                  class="form-input"
                  formControlName="whatsappNumber"
                  placeholder="Same as phone or different number">
                <p class="form-hint">Used for faster communication and notifications</p>
                <div *ngIf="profileForm.get('whatsappNumber')?.invalid && profileForm.get('whatsappNumber')?.touched" class="form-error">
                  <span *ngIf="profileForm.get('whatsappNumber')?.errors?.['pattern']">Invalid phone format</span>
                </div>
              </div>

              <!-- Governorate (dropdown) -->
              <div class="form-group">
                <label for="governorate" class="form-label">Governorate</label>
                <select
                  id="governorate"
                  class="form-input"
                  formControlName="governorate">
                  <option value="">-- Select Governorate --</option>
                  <option *ngFor="let gov of governorates" [value]="gov">{{ gov }}</option>
                </select>
              </div>

              <!-- City -->
              <div class="form-group">
                <label for="city" class="form-label">City / Area</label>
                <input
                  type="text"
                  id="city"
                  class="form-input"
                  formControlName="city"
                  placeholder="e.g. Tunis, La Marsa, Ariana, Sousse">
              </div>

              <!-- Address Line -->
              <div class="form-group">
                <label for="addressLine" class="form-label">Address</label>
                <input
                  type="text"
                  id="addressLine"
                  class="form-input"
                  formControlName="addressLine"
                  placeholder="Street, building, apartment, e.g. Rue de la Liberté 45">
                <p class="form-hint">Used for on-site repair or delivery services</p>
              </div>

              <!-- Postal Code -->
              <div class="form-group">
                <label for="postalCode" class="form-label">Postal Code</label>
                <input
                  type="text"
                  id="postalCode"
                  class="form-input"
                  formControlName="postalCode"
                  placeholder="e.g. 1002"
                  maxlength="4">
                <div *ngIf="profileForm.get('postalCode')?.invalid && profileForm.get('postalCode')?.touched" class="form-error">
                  <span *ngIf="profileForm.get('postalCode')?.errors?.['pattern']">Postal code must be 4 digits</span>
                </div>
              </div>

              <!-- Submit button -->
              <div class="form-actions">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="profileForm.invalid || profileLoading">
                  <span *ngIf="!profileLoading">Save Changes</span>
                  <span *ngIf="profileLoading" class="btn-loading">
                    <span class="spinner-small"></span>
                    Saving...
                  </span>
                </button>
              </div>

            </form>
          </div>
        </div>

        <!-- Security Tab (unchanged) -->
        <div *ngIf="activeTab === 'security'" class="tab-pane">
          <div class="settings-card">
            <div class="card-header">
              <h3 class="card-title">Change Password</h3>
              <p class="card-description">Ensure your account is using a strong password</p>
            </div>
            <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="form">
              <div class="form-group">
                <label for="currentPassword" class="form-label">Current Password</label>
                <input
                  type="password"
                  id="currentPassword"
                  class="form-input"
                  formControlName="currentPassword"
                  placeholder="Enter current password">
              </div>

              <div class="form-group">
                <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  id="newPassword"
                  class="form-input"
                  formControlName="newPassword"
                  placeholder="Enter new password">
                <div *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched" class="form-error">
                  <span *ngIf="passwordForm.get('newPassword')?.errors?.['required']">New password is required</span>
                  <span *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']">Password must be at least 6 characters</span>
                </div>
              </div>

              <div class="form-group">
                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="form-input"
                  formControlName="confirmPassword"
                  placeholder="Confirm new password">
                <div *ngIf="passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmPassword')?.touched" class="form-error">
                  Passwords do not match
                </div>
              </div>

              <div class="form-actions">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="passwordForm.invalid || passwordLoading">
                  <span *ngIf="!passwordLoading">Update Password</span>
                  <span *ngIf="passwordLoading" class="btn-loading">
                    <span class="spinner-small"></span>
                    Updating...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Danger Zone Tab (unchanged) -->
        <div *ngIf="activeTab === 'danger'" class="tab-pane">
          <div class="settings-card danger-card">
            <div class="card-header">
              <h3 class="card-title">Delete Account</h3>
              <p class="card-description">Permanently delete your account and all data</p>
            </div>
            <div class="danger-content">
              <div class="warning-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                  <line x1="12" y1="9" x2="12" y2="13"></line>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <div>
                  <h4>Warning: This action cannot be undone</h4>
                  <p>Deleting your account will:</p>
                  <ul>
                    <li>Permanently delete your profile and settings</li>
                    <li>Remove all your data from our servers</li>
                    <li>Cancel any active subscriptions</li>
                  </ul>
                </div>
              </div>
              <button class="btn btn-danger" (click)="confirmDelete()">
                Delete My Account
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div *ngIf="showDeleteConfirm" class="modal-overlay" (click)="cancelDelete()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirm Account Deletion</h3>
        </div>
        <div class="modal-body">
          <p>Are you absolutely sure you want to delete your account?</p>
          <p class="modal-warning">This action cannot be undone and all your data will be permanently deleted.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
          <button class="btn btn-danger" (click)="deleteAccount()">Yes, Delete My Account</button>
        </div>
      </div>
    </div>
  </div>
</div>
